# نظام الفهرسة المتقدم - التدفق الشامل

## المخطط الرئيسي لعملية الفهرسة الكاملة

```mermaid
flowchart TD
    %% بداية العملية
    A[إنشاء/تعديل كيان جديد] --> B{نوع العملية}
    
    %% تصنيف العمليات
    B -->|إنشاء جديد| C[حفظ في قاعدة البيانات]
    B -->|تعديل| D[تحديث قاعدة البيانات]
    B -->|حذف| E[حذف من قاعدة البيانات]
    
    %% معالجة الأحداث
    C --> F[إطلاق حدث PropertyCreated]
    D --> G[إطلاق حدث PropertyUpdated]
    E --> H[إطلاق حدث PropertyDeleted]
    
    %% معالجة الأحداث التلقائية
    F --> I[IndexAutoUpdateService]
    G --> I
    H --> I
    
    %% قرار التحديث
    I --> J{نوع التحديث المطلوب}
    J -->|تحديث فوري| K[تحديث فهرس محدد]
    J -->|إعادة بناء كاملة| L[تشغيل IndexGenerationService]
    
    %% عملية إنشاء الفهارس
    L --> M[تشغيل مهام متسلسلة]
    
    %% الفهارس الأساسية
    M --> N1[فهارس المدن<br/>GenerateCityIndexesAsync]
    M --> N2[فهارس الأسعار<br/>GeneratePriceRangeIndexesAsync]
    M --> N3[فهارس المرافق<br/>GenerateAmenityIndexesAsync]
    M --> N4[فهارس أنواع الكيانات<br/>GeneratePropertyTypeIndexesAsync]
    M --> N5[فهارس التوفر<br/>GenerateAvailabilityIndexesAsync]
    M --> N6[فهارس البحث النصي<br/>GenerateTextSearchIndexAsync]
    M --> N7[فهارس الحقول الديناميكية<br/>DynamicFieldIndexingService]
    
    %% معالجة فهارس المدن
    N1 --> O1[جلب جميع المدن من قاعدة البيانات]
    O1 --> P1[لكل مدينة: تحليل الكيانات]
    P1 --> Q1[حساب الإحصائيات]
    Q1 --> R1[تجميع نطاقات الأسعار]
    R1 --> S1[تجميع المرافق]
    S1 --> T1[إنشاء تقويم التوفر]
    T1 --> U1[ضغط البيانات GZIP]
    U1 --> V1[حفظ في ملف JSON<br/>cities/{cityName}.json]
    
    %% معالجة الفهارس الديناميكية
    N7 --> O7[جلب جميع UnitTypeFields]
    O7 --> P7[لكل حقل: تحليل القيم]
    P7 --> Q7[إنشاء فهرس القيم → معرفات الكيانات]
    Q7 --> R7[حساب النطاقات الرقمية]
    R7 --> S7[حساب البيانات الوصفية]
    S7 --> T7[إنشاء الفهارس الفرعية حسب نوع الكيان]
    T7 --> U7[ضغط وحفظ<br/>dynamic-fields/{fieldId}.json]
    
    %% انتهاء إنشاء الفهارس
    V1 --> W[انتهاء إنشاء جميع الفهارس]
    U7 --> W
    N2 --> X2[حفظ في price-ranges/]
    N3 --> X3[حفظ في amenities/]
    N4 --> X4[حفظ في property-types/]
    N5 --> X5[حفظ في availability/]
    N6 --> X6[حفظ في text-search/]
    X2 --> W
    X3 --> W
    X4 --> W
    X5 --> W
    X6 --> W
    
    %% بداية البحث
    W --> Y[نظام الفهرسة جاهز للاستخدام]
    Y --> Z[عميل يقوم بطلب بحث/فلترة]
    
    %% معالجة طلب البحث
    Z --> AA[FastSearchService.SearchAsync]
    AA --> BB[تحليل معايير البحث]
    BB --> CC{نوع البحث}
    
    %% أنواع البحث المختلفة
    CC -->|بحث نصي| DD[استخدام فهرس Trie]
    CC -->|فلترة جغرافية| EE[حساب المسافات + فهرس جغرافي]
    CC -->|فلاتر تقليدية| FF[قراءة الفهارس المناسبة]
    CC -->|حقول ديناميكية| GG[قراءة فهارس الحقول المخصصة]
    
    %% معالجة الفلاتر التقليدية
    FF --> HH1[قراءة فهرس المدينة من القرص]
    FF --> HH2[قراءة فهرس نطاق السعر من القرص]
    FF --> HH3[قراءة فهرس المرافق من القرص]
    
    %% فك الضغط وتحليل
    HH1 --> II1[فك ضغط GZIP]
    HH2 --> II2[فك ضغط GZIP]
    HH3 --> II3[فك ضغط GZIP]
    II1 --> JJ1[تحليل JSON → كائن CityIndex]
    II2 --> JJ2[تحليل JSON → كائن PriceRangeIndex]
    II3 --> JJ3[تحليل JSON → كائن AmenityIndex]
    
    %% حساب التقاطع
    JJ1 --> KK[حساب تقاطع معرفات الكيانات]
    JJ2 --> KK
    JJ3 --> KK
    GG --> LL[قراءة وتحليل فهارس الحقول الديناميكية]
    LL --> KK
    
    %% معالجة النتائج
    KK --> MM[قائمة معرفات الكيانات المطابقة]
    MM --> NN{هل النتائج في الكاش؟}
    NN -->|نعم| OO[استرجاع من Hot Cache]
    NN -->|لا| PP[تحميل تفاصيل الكيانات من قاعدة البيانات]
    
    %% تحضير النتائج النهائية
    PP --> QQ[تحويل إلى PropertySummary/PropertyWithDistance]
    OO --> QQ
    QQ --> RR[تطبيق الترتيب والترقيم]
    RR --> SS[حفظ في الكاش للمرات القادمة]
    SS --> TT[إرجاع النتائج للعميل]
    
    %% دورة تنظيف الكاش
    TT --> UU[تشغيل تنظيف دوري للكاش]
    UU --> VV{هل الكاش ممتلئ؟}
    VV -->|نعم| WW[حذف العناصر الأقل استخداماً]
    VV -->|لا| XX[الحفاظ على الكاش الحالي]
    WW --> XX
    XX --> Y
    
    %% تحديث الفهارس التلقائي
    K --> YY[تحديث الفهرس المحدد]
    YY --> ZZ[إعادة ضغط وحفظ]
    ZZ --> AAA[تحديث الكاش الساخن]
    AAA --> BBB[الفهرس محدث وجاهز]
    BBB --> Y

    %% التنسيق والألوان
    classDef database fill:#e1f5fe
    classDef indexing fill:#f3e5f5
    classDef search fill:#e8f5e8
    classDef cache fill:#fff3e0
    classDef file fill:#fce4ec
    
    class C,D,E,O1,O7,PP database
    class N1,N2,N3,N4,N5,N6,N7,L,M indexing
    class AA,BB,CC,DD,EE,FF,GG search
    class NN,OO,SS,UU,VV,WW,XX,AAA cache
    class V1,U7,X2,X3,X4,X5,X6,HH1,HH2,HH3 file
```

## شرح مراحل التدفق الرئيسية:

### 1. مرحلة إنشاء/تعديل البيانات
- إنشاء أو تعديل كيان في قاعدة البيانات
- إطلاق الأحداث المناسبة (Domain Events)
- معالجة الأحداث عبر IndexAutoUpdateService

### 2. مرحلة إنشاء الفهارس (بعد تحسين التزامن)
- تنفيذ المهام بشكل **متسلسل** داخل ‎IndexGenerationService‎ لضمان سلامة ‎DbContext‎.
- كل نوع فهرس يُعالج على حدة باستخدام نفس السياق، ما يمنع ‎InvalidOperationException‎.
- ما زال يمكن تشغيل أنواع فهارس مختلفة في خدمات مستقلة عند توفير ‎IDbContextFactory‎ مستقبلاً.
- يتم ضغط البيانات باستخدام ‎GZIP‎ وحفظها في ملفات ‎JSON‎.

### 3. مرحلة البحث والفلترة
- استقبال طلب البحث من العميل
- تحليل معايير البحث
- قراءة الفهارس المناسبة من القرص
- حساب تقاطع النتائج
- تحضير وإرجاع البيانات للعميل

### 4. إدارة الكاش والتحديث
- استخدام ‎SemaphoreSlim‎ لكل ملف داخل ‎JsonIndexFileService‎ لضمان القراءة/الكتابة الآمنة.
- تنظيف دوري للكاش الساخن وإزالة العناصر المنتهية الصلاحية.
- تحديث الفهارس عند تغيير البيانات باستخدام ‎IncrementalIndexService‎ دون تعارضات تزامن.
- مراقبة حجم الكاش وإدارته ديناميكياً.